nextflow_workflow {

    name "Test Subworkflow ARRIBA_WORKFLOW"
    script "../main.nf"
    workflow "ARRIBA_WORKFLOW"
    tag "subworkflow"
    tag "arriba"
    tag "arriba/arriba"
    tag "samtools"
    tag "samtools/index"
    tag "samtools/sort"
    tag "samtools/view"
    tag "star"
    tag "star/genomegenerate"
    tag "star/align"


    // Test #1 Indexing
    test("ARRIBA_WORKFLOW - Homo sapiens - FASTQs chr4") {

        setup {
            // Create genome index for STAR
            run("STAR_GENOMEGENERATE") {
                script "../../../../modules/nf-core/star/genomegenerate/main.nf"
                process {
                """
                    // FASTA
                    input[0] = Channel.fromPath(
                            "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.1700000-54900000.fa", checkIfExists: true
                        )
                        .map{ [[id: it.getName() ], it ]}

                    // GTF
                    input[1] = Channel.fromPath(
                            "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.gtf", checkIfExists: true
                        )
                        .map{ [[id: it.getName() ], it ]}
                    """
                }
            }
        }

        when {
            workflow {
                """
                // ch_reads
                input[0] = Channel.of(
                    [
                        [ id: "test_fastqs" ],
                        [
                            file("https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/human/reads_1.fq.gz", checkIfExists: true),
                            file("https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/human/reads_2.fq.gz", checkIfExists: true)
                        ]
                    ] )

                // ch_gtf
                input[1] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.gtf", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_fasta
                input[2] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.1700000-54900000.fa", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_starindex_ref
                input[3] = STAR_GENOMEGENERATE.out.index

                // ch_arriba_ref_blacklist
                input[4] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/blacklist_hg38_GRCh38_v2.4.0.tsv.gz", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_known_fusions
                input[5] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/known_fusions_hg38_GRCh38_v2.4.0.tsv.gz", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_cytobands
                input[6] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/cytobands_hg38_GRCh38_v2.4.0.tsv", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_protein_domains
                input[7] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/protein_domains_hg38_GRCh38_v2.4.0.gff3", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // arriba (boolean)
                input[8] = true

                // all (boolean)
                input[9] = true

                // fusioninspector_only  (boolean)
                input[10] = false

                // star_ignore_sjdbgtf (boolean)
                input[11] = false

                // seq_center (string)
                input[12] = 'test_center'

                // arriba_fusions (path)
                input[13] = null

                // cram (array)
                input[14] = [ 'arriba' ]
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { with(workflow.out) {
                    assert snapshot(
                            file(fusions[0][1]),
                            file(fusions_fail[0]),
                            file(cram_index[0][1]).name,
                            file(cram_index[0][2]).name,
                            versions.collect{ file(it) }
                        ).match()
                    }
                }
            )
        }
    }


    // Test #2 With arriba_fusions file
    test("ARRIBA_WORKFLOW - Homo sapiens - FASTQs chr4 - External fusion file") {

        setup {
            // Create genome index for STAR
            run("STAR_GENOMEGENERATE") {
                script "../../../../modules/nf-core/star/genomegenerate/main.nf"
                process {
                """
                    // FASTA
                    input[0] = Channel.fromPath(
                            "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.1700000-54900000.fa", checkIfExists: true
                        )
                        .map{ [[id: it.getName() ], it ]}

                    // GTF
                    input[1] = Channel.fromPath(
                            "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.gtf", checkIfExists: true
                        )
                        .map{ [[id: it.getName() ], it ]}
                    """
                }
            }
        }

        when {
            workflow {
                """
                // ch_reads
                input[0] = Channel.of(
                    [
                        [ id: "test_fastqs" ],
                        [
                            file("https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/human/reads_1.fq.gz", checkIfExists: true),
                            file("https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/human/reads_2.fq.gz", checkIfExists: true)
                        ]
                    ] )

                // ch_gtf
                input[1] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.gtf", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_fasta
                input[2] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.1700000-54900000.fa", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_starindex_ref
                input[3] = STAR_GENOMEGENERATE.out.index

                // ch_arriba_ref_blacklist
                input[4] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/blacklist_hg38_GRCh38_v2.4.0.tsv.gz", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_known_fusions
                input[5] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/known_fusions_hg38_GRCh38_v2.4.0.tsv.gz", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_cytobands
                input[6] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/cytobands_hg38_GRCh38_v2.4.0.tsv", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_protein_domains
                input[7] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/protein_domains_hg38_GRCh38_v2.4.0.gff3", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // arriba (boolean)
                input[8] = true

                // all (boolean)
                input[9] = true

                // fusioninspector_only  (boolean)
                input[10] = false

                // star_ignore_sjdbgtf (boolean)
                input[11] = false

                // seq_center (string)
                input[12] = 'test_center'

                // arriba_fusions (string path)
                input[13] = "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/test_fastqs.arriba.fusions.tsv"

                // cram (array)
                input[14] = [ 'arriba' ]
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { with(workflow.out) {
                    assert snapshot(
                            fusions[0].size() == 2,
                            fusions_fail.size() == 1,
                            file(cram_index[0][1]).name,
                            file(cram_index[0][2]).name,
                            versions.collect{ file(it) }
                        ).match()
                    }
                }
            )
        }
    }

    // TEST #3 WITHOUT INDEXING
    test("ARRIBA_WORKFLOW - Homo sapiens - FASTQs chr4 - cram = []") {

        setup {
            // Create genome index for STAR
            run("STAR_GENOMEGENERATE") {
                script "../../../../modules/nf-core/star/genomegenerate/main.nf"
                process {
                """
                    // FASTA
                    input[0] = Channel.fromPath(
                            "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.1700000-54900000.fa", checkIfExists: true
                        )
                        .map{ [[id: it.getName() ], it ]}

                    // GTF
                    input[1] = Channel.fromPath(
                            "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.gtf", checkIfExists: true
                        )
                        .map{ [[id: it.getName() ], it ]}
                    """
                }
            }
        }

        when {
            workflow {
                """
                // ch_reads
                input[0] = Channel.of(
                    [
                        [ id: "test_fastqs" ],
                        [
                            file("https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/human/reads_1.fq.gz", checkIfExists: true),
                            file("https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/human/reads_2.fq.gz", checkIfExists: true)
                        ]
                    ] )

                // ch_gtf
                input[1] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.gtf", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_fasta
                input[2] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/ensembl/Homo_sapiens.GRCh38.102.chr4.1700000-54900000.fa", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_starindex_ref
                input[3] = STAR_GENOMEGENERATE.out.index

                // ch_arriba_ref_blacklist
                input[4] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/blacklist_hg38_GRCh38_v2.4.0.tsv.gz", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_known_fusions
                input[5] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/known_fusions_hg38_GRCh38_v2.4.0.tsv.gz", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_cytobands
                input[6] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/cytobands_hg38_GRCh38_v2.4.0.tsv", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // ch_arriba_ref_protein_domains
                input[7] =
                    Channel.fromPath(
                        "https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/rnafusion/testdata/reference/arriba/protein_domains_hg38_GRCh38_v2.4.0.gff3", checkIfExists: true
                    )
                    .map{ [ [ id: it.name ], it ] }

                // arriba (boolean)
                input[8] = true

                // all (boolean)
                input[9] = true

                // fusioninspector_only  (boolean)
                input[10] = false

                // star_ignore_sjdbgtf (boolean)
                input[11] = false

                // seq_center (string)
                input[12] = 'test_center'

                // arriba_fusions (path)
                input[13] = null

                // cram (array)
                input[14] = [ ]
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { with(workflow.out) {
                    assert snapshot(
                            file(fusions[0][1]),
                            file(fusions_fail[0]),
                            cram_index.size() == 0,
                            versions.collect{ file(it) }
                        ).match()
                    }
                }
            )
        }
    }

}
